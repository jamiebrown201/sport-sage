<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sport Sage - Scraper Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
          }
        }
      }
    }
  </script>
  <style>
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold text-primary">Sport Sage Dashboard</h1>
        <div class="flex items-center gap-4">
          <span id="lastUpdate" class="text-sm text-gray-400"></span>
          <button onclick="refresh()" class="px-4 py-2 bg-primary rounded-lg hover:bg-primary/80 transition">
            Refresh
          </button>
        </div>
      </div>
      <p class="text-gray-400 mt-2">Scraper monitoring and source health</p>
    </header>

    <!-- Health Status -->
    <section class="mb-8">
      <div id="healthStatus" class="p-6 rounded-xl bg-gray-800 border border-gray-700">
        <div class="flex items-center gap-3">
          <div id="healthIndicator" class="w-4 h-4 rounded-full bg-gray-500 pulse"></div>
          <span id="healthText" class="text-xl font-semibold">Loading...</span>
        </div>
      </div>
    </section>

    <!-- Summary Cards -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="p-6 rounded-xl bg-gray-800 border border-gray-700">
        <div class="text-sm text-gray-400 mb-1">Total Runs (24h)</div>
        <div id="totalRuns" class="text-3xl font-bold">-</div>
      </div>
      <div class="p-6 rounded-xl bg-gray-800 border border-gray-700">
        <div class="text-sm text-gray-400 mb-1">Success Rate</div>
        <div id="successRate" class="text-3xl font-bold text-green-400">-</div>
      </div>
      <div class="p-6 rounded-xl bg-gray-800 border border-gray-700">
        <div class="text-sm text-gray-400 mb-1">Items Processed</div>
        <div id="itemsProcessed" class="text-3xl font-bold">-</div>
      </div>
      <div class="p-6 rounded-xl bg-gray-800 border border-gray-700">
        <div class="text-sm text-gray-400 mb-1">Active Alerts</div>
        <div id="activeAlerts" class="text-3xl font-bold text-yellow-400">-</div>
      </div>
    </section>

    <!-- Source Status -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-4">Source Health</h2>
      <div id="sourceGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Populated by JS -->
      </div>
    </section>

    <!-- Alerts -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-4">Active Alerts</h2>
      <div id="alertsList" class="space-y-2">
        <!-- Populated by JS -->
      </div>
    </section>

    <!-- Recent Runs -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-4">Recent Runs</h2>
      <div class="overflow-x-auto rounded-xl bg-gray-800 border border-gray-700">
        <table class="w-full text-sm">
          <thead class="bg-gray-700">
            <tr>
              <th class="px-4 py-3 text-left">Job</th>
              <th class="px-4 py-3 text-left">Source</th>
              <th class="px-4 py-3 text-left">Status</th>
              <th class="px-4 py-3 text-left">Duration</th>
              <th class="px-4 py-3 text-left">Items</th>
              <th class="px-4 py-3 text-left">Time</th>
            </tr>
          </thead>
          <tbody id="runsTable">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- API Config -->
    <section class="mb-8">
      <details class="bg-gray-800 rounded-xl border border-gray-700 p-4">
        <summary class="cursor-pointer font-semibold">API Configuration</summary>
        <div class="mt-4 space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">API Base URL</label>
            <input id="apiUrl" type="text" value="" placeholder="https://your-api.execute-api.region.amazonaws.com"
              class="w-full px-3 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:border-primary focus:outline-none">
          </div>
          <button onclick="saveConfig()" class="px-4 py-2 bg-primary rounded-lg hover:bg-primary/80">
            Save & Reload
          </button>
        </div>
      </details>
    </section>
  </div>

  <script>
    // Config
    let API_URL = localStorage.getItem('apiUrl') || 'https://4sdgyzrf7k.execute-api.eu-west-1.amazonaws.com';

    // Init
    document.getElementById('apiUrl').value = API_URL;

    function saveConfig() {
      API_URL = document.getElementById('apiUrl').value;
      localStorage.setItem('apiUrl', API_URL);
      refresh();
    }

    async function fetchApi(endpoint) {
      try {
        const res = await fetch(`${API_URL}/api/monitoring${endpoint}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (e) {
        console.error(`API error (${endpoint}):`, e);
        return null;
      }
    }

    async function refresh() {
      document.getElementById('lastUpdate').textContent = `Updating...`;

      // Fetch all data in parallel
      const [dashboard, sources, health] = await Promise.all([
        fetchApi('/dashboard'),
        fetchApi('/sources'),
        fetchApi('/health'),
      ]);

      // Update health
      if (health) {
        const indicator = document.getElementById('healthIndicator');
        const text = document.getElementById('healthText');
        indicator.className = 'w-4 h-4 rounded-full ' +
          (health.status === 'healthy' ? 'bg-green-500' : 'bg-red-500 pulse');
        text.textContent = health.status === 'healthy' ? 'System Healthy' : 'System Degraded';
      }

      // Update summary
      if (dashboard) {
        document.getElementById('totalRuns').textContent = dashboard.summary.totalRuns;
        const rate = dashboard.summary.totalRuns > 0
          ? Math.round((dashboard.summary.successful / dashboard.summary.totalRuns) * 100)
          : 0;
        document.getElementById('successRate').textContent = `${rate}%`;
        document.getElementById('itemsProcessed').textContent =
          dashboard.summary.totalItemsProcessed.toLocaleString();
        document.getElementById('activeAlerts').textContent = dashboard.summary.activeAlerts;

        // Update runs table
        const tbody = document.getElementById('runsTable');
        tbody.innerHTML = dashboard.recentRuns.map(run => `
          <tr class="border-t border-gray-700 hover:bg-gray-700/50">
            <td class="px-4 py-3 font-mono text-xs">${run.jobType}</td>
            <td class="px-4 py-3">${run.source}</td>
            <td class="px-4 py-3">
              <span class="px-2 py-1 rounded text-xs ${
                run.status === 'success' ? 'bg-green-900 text-green-300' :
                run.status === 'failed' ? 'bg-red-900 text-red-300' :
                run.status === 'running' ? 'bg-blue-900 text-blue-300' :
                'bg-yellow-900 text-yellow-300'
              }">${run.status}</span>
            </td>
            <td class="px-4 py-3 text-gray-400">${run.durationFormatted || '-'}</td>
            <td class="px-4 py-3">${run.itemsProcessed || 0}</td>
            <td class="px-4 py-3 text-gray-400 text-xs">${new Date(run.startedAt).toLocaleTimeString()}</td>
          </tr>
        `).join('');

        // Update alerts
        const alertsList = document.getElementById('alertsList');
        if (dashboard.activeAlerts.length === 0) {
          alertsList.innerHTML = '<p class="text-gray-400 p-4 bg-gray-800 rounded-xl">No active alerts</p>';
        } else {
          alertsList.innerHTML = dashboard.activeAlerts.map(alert => `
            <div class="p-4 rounded-xl border ${
              alert.severity === 'critical' ? 'bg-red-900/30 border-red-700' :
              alert.severity === 'error' ? 'bg-red-900/20 border-red-800' :
              alert.severity === 'warning' ? 'bg-yellow-900/20 border-yellow-800' :
              'bg-gray-800 border-gray-700'
            }">
              <div class="flex items-center justify-between">
                <div>
                  <span class="text-xs uppercase font-semibold ${
                    alert.severity === 'critical' ? 'text-red-400' :
                    alert.severity === 'error' ? 'text-red-300' :
                    'text-yellow-400'
                  }">${alert.severity}</span>
                  <span class="text-xs text-gray-500 ml-2">${alert.type}</span>
                </div>
                <button onclick="acknowledgeAlert('${alert.id}')" class="text-xs text-gray-400 hover:text-white">
                  Acknowledge
                </button>
              </div>
              <p class="mt-1">${alert.message}</p>
              <p class="text-xs text-gray-500 mt-1">${new Date(alert.createdAt).toLocaleString()}</p>
            </div>
          `).join('');
        }
      }

      // Update source grid
      if (sources) {
        const grid = document.getElementById('sourceGrid');
        grid.innerHTML = Object.entries(sources.sources).map(([name, data]) => `
          <div class="p-4 rounded-xl bg-gray-800 border ${
            data.status === 'healthy' ? 'border-green-700' :
            data.status === 'down' ? 'border-red-700' :
            data.status === 'cooldown' ? 'border-orange-700' :
            data.status === 'degraded' ? 'border-yellow-700' :
            'border-gray-700'
          }">
            <div class="flex items-center justify-between mb-2">
              <span class="font-semibold capitalize">${name}</span>
              <span class="w-3 h-3 rounded-full ${
                data.status === 'healthy' ? 'bg-green-500' :
                data.status === 'down' ? 'bg-red-500' :
                data.status === 'cooldown' ? 'bg-orange-500 pulse' :
                data.status === 'degraded' ? 'bg-yellow-500' :
                'bg-gray-500'
              }"></span>
            </div>
            <div class="text-2xl font-bold ${
              data.successRate >= 80 ? 'text-green-400' :
              data.successRate >= 50 ? 'text-yellow-400' :
              data.successRate > 0 ? 'text-red-400' :
              'text-gray-500'
            }">${data.successRate}%</div>
            <div class="text-xs text-gray-400 mt-1">
              ${data.successCount} success / ${data.failCount} fail
            </div>
            ${data.status === 'cooldown' && data.nextRetryAt ?
              `<div class="text-xs text-orange-400 mt-1">Retry at ${new Date(data.nextRetryAt).toLocaleTimeString()}</div>` :
              data.lastRun ? `<div class="text-xs text-gray-500 mt-1">Last: ${new Date(data.lastRun).toLocaleTimeString()}</div>` : ''
            }
          </div>
        `).join('');
      }

      document.getElementById('lastUpdate').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
    }

    async function acknowledgeAlert(alertId) {
      await fetch(`${API_URL}/api/monitoring/alerts/${alertId}/acknowledge`, { method: 'POST' });
      refresh();
    }

    // Initial load and auto-refresh
    refresh();
    setInterval(refresh, 30000); // Refresh every 30 seconds
  </script>
</body>
</html>
